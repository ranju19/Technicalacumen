const rss2json = 'https://api.rss2json.com/v1/api.json?rss_url=';

const feeds = {
  highlights: [
    'https://techcrunch.com/feed/',
    'https://www.theverge.com/rss/index.xml',
    'https://venturebeat.com/feed/',
    'https://feeds.arstechnica.com/arstechnica/index',
    'https://www.technologyreview.com/feed/'
  ],
  trending: [
    'https://news.ycombinator.com/rss',
    'https://www.analyticsvidhya.com/blog/feed/',
    'https://www.zdnet.com/news/rss.xml',
    'https://thenextweb.com/feed',
    'https://www.cnet.com/rss/news/'
  ]
};

// Create a slide item for carousels
function createSlide(item) {
  let imageUrl = item.thumbnail && item.thumbnail.startsWith('http')
    ? item.thumbnail
    : 'https://placehold.co/300x200?text=News';

  if (item.thumbnail) {
    imageUrl = item.thumbnail;
  } else if (item.enclosure && item.enclosure.link) {
    imageUrl = item.enclosure.link;
  } else {
    const imgMatch = item.description.match(/<img[^>]+src="([^">]+)"/);
    if (imgMatch && imgMatch[1]) {
      imageUrl = imgMatch[1];
    }
  }

  return `
    <div class="carousel-slide">
      <img src="${imageUrl}" alt="News image" style="width:100%; height: 200px; object-fit: cover; border-radius: 10px;">
      <h4><a href="${item.link}" target="_blank">${item.title}</a></h4>
      <p>${item.description.slice(0, 100)}...</p>
    </div>
  `;
}

// Track current slide indexes
let slideIndex = 0;
let miniSlideIndex = 0;

// Show slides for main carousel
function showMainSlides() {
  const slides = document.querySelectorAll(`#carousel-slides .carousel-slide`);
  slides.forEach((slide, i) => {
    slide.style.display = (i === slideIndex % slides.length) ? 'block' : 'none';
  });
}

// Show slides for mini carousel
function showMiniSlides() {
  const slides = document.querySelectorAll(`#mini-carousel-slides .carousel-slide`);
  slides.forEach((slide, i) => {
    slide.style.display = (i === miniSlideIndex % slides.length) ? 'block' : 'none';
  });
}

// Navigation buttons for main carousel
function nextSlide() {
  const slides = document.querySelectorAll('#carousel-slides .carousel-slide');
  slideIndex = (slideIndex + 1) % slides.length;
  showMainSlides();
}

function prevSlide() {
  const slides = document.querySelectorAll('#carousel-slides .carousel-slide');
  slideIndex = (slideIndex - 1 + slides.length) % slides.length;
  showMainSlides();
}

// Navigation buttons for mini carousel
function nextMiniSlide() {
  const slides = document.querySelectorAll('#mini-carousel-slides .carousel-slide');
  miniSlideIndex = (miniSlideIndex + 1) % slides.length;
  showMiniSlides();
}

function prevMiniSlide() {
  const slides = document.querySelectorAll('#mini-carousel-slides .carousel-slide');
  miniSlideIndex = (miniSlideIndex - 1 + slides.length) % slides.length;
  showMiniSlides();
}

// Load feed and render content
async function loadRSSFeed(feedUrls, containerId, limit = 10, isCarousel = false) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  let allItems = [];

  for (const url of feedUrls) {
    try {
      const res = await fetch(rss2json + encodeURIComponent(url));
      const data = await res.json();
      if (data.items && Array.isArray(data.items)) {
        allItems = allItems.concat(data.items.slice(0, limit));
      }
    } catch (err) {
      console.error('Feed fetch error for', url);
    }
  }

  allItems = allItems.slice(0, limit);

  // Remove duplicates
  const uniqueLinks = new Set();
  allItems = allItems.filter(item => {
    if (uniqueLinks.has(item.link)) return false;
    uniqueLinks.add(item.link);
    return true;
  });

  if (isCarousel) {
    container.innerHTML = allItems.map(createSlide).join('');
    if (containerId === 'carousel-slides') {
      showMainSlides();
    } else if (containerId === 'mini-carousel-slides') {
      showMiniSlides();
    }
  } else {
    allItems.forEach(item => {
      const div = document.createElement('div');
      div.className = 'news-card';

      let imageUrl = item.thumbnail && item.thumbnail.startsWith('http') ? item.thumbnail : '';

      if (!imageUrl && item.enclosure && item.enclosure.link) {
        imageUrl = item.enclosure.link;
      } else if (!imageUrl) {
        const imgMatch = item.description.match(/<img[^>]+src="([^">]+)"/);
        if (imgMatch && imgMatch[1]) {
          imageUrl = imgMatch[1];
        }
      }

      if (!imageUrl) {
        imageUrl = 'https://placehold.co/300x200?text=News';
      }

      div.innerHTML = `
        <img src="${imageUrl}" alt="News Image" style="width:100%; height:200px; object-fit:cover; border-radius:8px;">
        <h4><a href="${item.link}" target="_blank">${item.title}</a></h4>
        <p>${item.description.slice(0, 100)}...</p>
      `;
      container.appendChild(div);
    });
  }
}

// Load all sections
loadRSSFeed(feeds.highlights, 'carousel-slides', 10, true);
loadRSSFeed(feeds.trending, 'mini-carousel-slides', 10, true);
loadRSSFeed([feeds.highlights[0]], 'mini-highlight-1', 1);
loadRSSFeed([feeds.highlights[1]], 'mini-highlight-2', 1);
loadRSSFeed([feeds.trending[0]], 'highlight-small', 1);
loadRSSFeed([feeds.trending[2]], 'highlight-static', 1);
